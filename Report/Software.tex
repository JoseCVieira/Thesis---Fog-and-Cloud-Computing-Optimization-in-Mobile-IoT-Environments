\chapter{Desenvolvimento da programação da unidade central}
Neste capítulo são abordadas as rotinas de programação desenvolvidas e implementadas para o correto funcionamento da U3C. Este é divido em duas partes, a programação do microcontrolador, onde são apresentados fluxogramas dos códigos desenvolvidos para o módulo GSM e para o RF, e o desenvolvimento de uma aplicação \textit{Android} que servirá de interface gráfica para o utilizador na configuração da unidade e na atuação de periféricos.
\section{Programação do microcontrolador}
As rotinas de programação mais relevantes no desenvolvimento do \textit{firmware} do microcontrolador são: a comunicação com o módulo GSM, onde é feita a sua configuração e toda a troca de dados realizada entre o GSM e o dispositivo \textit{Android} (via UART), e a interface com módulo RF, onde é feita a sua programação/configuração (via SPI) e a receção de dados vindos dos comandos remotos através de uma linha digital.
\subsection{Interface com módulo GSM}
Os módulos GSM, tipicamente, utilizam uma comunicação série (UART) para a troca de dados com a unidade de controlo (e.g., microcontrolador), onde, esta é realizada por comandos AT. Estes comandos permitem efetuar todas configurações e ações necessárias, em que, em cada comando enviado existe uma resposta, seja ela, de confirmação, erro ou uma resposta ao comando/pedido.\\[6pt]
No processo inicial é feita a verificação da existência do módulo GSM, pois, como já referido, é possível implementar a U3C sem este módulo, ou mesmo para a deteção uma possível avaria do mesmo. Não detetando a sua presença, todas as suas rotinas de programação deixam de ser utilizadas, tendo assim a vantagem de, independentemente da sua presença ou não, a U3C não necessita de \textit{firmwares} diferentes.\\[6pt]
Após a sua deteção, é feita a configuração inicial para obter o funcionamento desejado, que inclui a funcionalidade que define que quando é recebida uma chamada é envido, via UART, o número de telefone do chamador, pois, por defeito, o módulo só envia um comando de receção de chamada, não identificando o número. A configuração inclui, também, tipo de formato da SMS que pode ser em texto ou \textit{protocol data unit} (PDU).\\[6pt]
Periodicamente, é efetuado um pedido à rede com o objetivo de adquirir o nível de sinal recebido, que posteriormente será sinalizado adequadamente pelo LED RGB\\[6pt]
Com o auxílio da aplicação \textit{Android}, a comunicação via GSM permite ao utilizador adicionar ou remover utilizadores, listar todos os utilizadores guardados, efetuar o ajuste da hora, realizar o pedido do nível de rede ou do saldo da central, e ainda atuar saídas, de forma remota. Todos estes comandos/pedidos são constituídos por um conjunto de dados que permite a identificação da ação pretendida. Como a U3C tem como objetivo ser comercializado, estes dados são confidenciais para a segurança do produto.\\[6pt]
Os comandos enviados por parte dos utilizadores são identificados de duas formas diferentes, por chamada ou SMS. Estas são recebidas no módulo GSM e enviados via UART para o microcontrolador, onde existe uma verificação contínua na reserva de dados da UART (buffer da UART), e serão tratados de forma diferente. Nas chamadas, apenas é verificado a existência do identificador do chamador em memória, e é atuada a saída correspondente, caso este pertença à lista de utilizador, por fim é desligada a chamada. A chamada permite ao utilizador, o envio de um comando de forma gratuita, visto que ela não é atendida, contudo apenas pode atuar uma das saídas, pois, não existe forma de identificar o que é pretendido pelo utilizador com recurso apenas ao seu número identificador. Quando se trata de um SMS, é, da mesma forma, verificada a sua existência em memória, onde posteriormente é atuada a saída dependendo do comando enviado.\\[6pt]
Os comandos enviados para o módulo GSM passam por um processo que permite obter um \textit{feedback} fidedigno da entrega do comando. A partir de uma função onde as variáveis de entrada são o comando e o tempo máximo da resposta, é enviado o comando e iniciado um contador, que cronometrará o tempo de resposta. Se o contador exceder o tempo máximo definido, o processo termina e é devolvido um erro de comunicação do comando, caso contrário a resposta será positiva. Na figura \ref{fig:gsmdia} encontra-se um fluxograma do processo de envio de comandos.

\begin{figure}[H]
	\centering
	\includegraphics[clip, trim=7.5cm 17cm 6cm 1cm, width=0.4\linewidth]{Figuras/Software/gsm}
	\caption{Fluxograma do processo de envio de comandos para módulo GSM.}
	\label{fig:gsmdia}
\end{figure}

\subsection{Interface com módulo RF}
\subsubsection{Programação do módulo}
Para o correto funcionamento do módulo RF é necessário o envio de alguns comandos por SPI, para se conseguir obter a receção e desmodelação dos dados enviados pelos comandos remotos de forma correta.\\[6pt]
O módulo trancetor pode ser configurado em vários modos de operação, entre eles: \textit{Sleep}, \textit{Standby}, \textit{Frequency Synthesizer}, \textit{Transmitter} ou \textit{Receiver}. Neste caso o modo utilizado é o recetor pois o módulo irá essencialmente a captar comandos de radiofrequencia. Para além disso é definido o tipo de modelação utilizado na onda portadora, o filtro digital, e ainda o modo de processamento de dados. Como o transcetor irá estar em modo de receção, o tipo de modelação escolhida é a utilizada pelos transmissores (comandos RF), que na prática foi verificado que se trata de uma modelação OOK. No filtro de receção não foi utilizado nenhum formato (ou seja, \textit{no shaping}). Este filtro seria crítico ao nível da transmissão de dados. Pois ao transmitir pulsos quadrados resulta no espetro da frequência, num seno cardinal. Isto significa na teoria estar a transmitir um sinal em frequências compreendidas entre $[-\infty;\infty]$. Na prática como estes pulsos não iriam ser perfeitos, a sua largura de banda não seria infinita, mas estaria ainda assim a transmitir em frequências não desejadas, tendo impacto a nível de interferência para com outros sistemas. Ao nível da receção, os filtros adaptados são utilizados, por norma, quando é também utilizado o mesmo filtro na transmissão dos sinais. Na prática verificou-se que isso não acontece, tal como apresenta a figura \ref{fig:codigocomando}, os pulsos antes de modelados na frequência, não apresentam qualquer tipo de passagem por um filtro adaptado, visto que nos dados existem variações bruscas nas comutações entre os níveis lógicos do sinal.
\begin{figure}[H]
	\centering
	\includegraphics[width=0.6\linewidth]{Figuras/codigoComando}
	\caption{Sequência de dados de um comando de teste.}
	\label{fig:codigocomando}
\end{figure}
O modo de processamento de dados, pode ser em modo contínuo ou em \textit{packet mode}. Nesta opção foi escolhido o processamento em modo contínuo, este permite a visualização dos dados recebidos em tempo real e com a possibilidade de serem diretamente acedidos pelo microcontrolador. Esta funcionalidade não era permitida no \textit{packet mode} pois este guarda os dados numa \textit{first in, first out} (FIFO), que mais tarde poderá ser acedida via SPI. Isto criaria atrasos indesejados.\\[6pt]
Foi ainda configurado o \textit{bit rate} médio dos comandos transmissores utilizados para teste. Como se pode observar pela figura \ref{fig:codigocomando}, um tempo de símbolo tem a duração de 380 us que corresponde a um valor de 2.632 kb/s. Os valores de \textit{bit rate} são bastante próximos em todos os comandos, ainda assim o valor escolhido de \textit{bit rate} foi de 2.4 kb/s, pois existiam valores mais a cima e outros mais abaixo.\\[6pt]
A frequência da portadora da onda de entrada também foi configurada. Tal como já mencionado, foi escolhida a frequência 433 MHz para os valores dos componentes do circuito. Para a configuração do módulo trancetor foi medido e testado o valor mais adequado e abrangente a nível da receção dos sinais provenientes dos transmissores. Pois estes comandos têm um possível erro (desvio de frequência) na ordem dos kHz.\\[6pt]
Por fim, foi configurada a largura de banda do filtro de receção. Este parâmetro serve para escolher a largara de banda em que se quer captar dados, centrada na frequência da portadora. Neste parâmetro foi escolhido a maior largura de banda que o módulo permitia para este tipo de modelação (OOK), 250 kHz.
\subsubsection{\textit{Firmware} para otenção de comandos}
\begin{itemize}
	\item Diagrama geral
\end{itemize}
\begin{figure}[H]
	\centering
	\makebox[\textwidth][c]{\includegraphics[clip, trim=0cm 1cm 0.5cm 0cm, width=1\linewidth]{Figuras/DiagramafuncionalRF}}
	\caption{Fluxograma da obtenção de comandos.}
	\label{fig:diagramafuncionalrf}
\end{figure}
Posteriormente à configuração do módulo transcetor RF, foi dado o início da programação do microcontrolador para a obtenção de comandos. Para o efeito, foi desenvolvido um diagrama funcional/máquina de estados com o intuito de organizar todo esse processo, desde a obtenção do código até ao acionamento da saída.\\[6pt]
Como se pode observar no diagrama apresentado na figura \ref{fig:diagramafuncionalrf}, apartir do momento em que o \textit{threshold} definido é excedido, é iniciado o processo de obtenção do código. Como em qualquer receção de dados, o primeiro passo é definir o tempo de amostragem, este foi definido ser 8 amostras por símbolo. Para esta obtenção do tempo é necessária uma trama, a primeira trama recebida no caso de conter símbolos suficientes para o efeito. Caso não contenha será utilizada também a segunda trama. Aquando da descoberta deste tempo será necessário encontrar o fim da trama atual e posterior início da próxima trama para aí ser começada a obtenção do código. Se no final da receção, for verificado que o código recebido é válido, a máquina de estados passa para a segunda etapa.\\[6pt]
Esta etapa passa por identificar a operação a efetuar. Caso o botão de programação, disponibilizado ao utilizador, tenha sido pressionado, será realizada a operação de guardar em memória o comando recebido. Para isso, é feita uma pesquisa na memória para identificar se o comando está contido na memória. 
Caso não exista, são adicionados todos os dados: se é código fixo ou rolling code (para facilitar a futura pesquisa), o código e a saída alocada a este código (selecionada pelo utilizador com a interface LED). Caso o código já exista em memória, apenas é atualizada a sua saída. Caso o botão não tenha sido pressionado, a operação será de acionamento de mecanismos. Para isso é feita, de igual forma, uma pesquisa na memória para verificar se o código realmente existe. Se existir será enviado um pulso para respetiva saída. Caso não exista, nada é feito.

\begin{itemize}
	\item Tempo de amostragem
\end{itemize}
{O primeiro passo para obter um código (fazer amostragem do sinal), seja ele qual for, é definir o tempo de amostragem. Para isso foi definido que o número de amostras num simbolo seria 8. Na realidade como o sistema não é ideal e é suscetível a pequenos desvios, vão existir sempre, entre 7 a 9 amostras num símbolo. Então, para definir o tempo de amostragem apenas é necessário determinar o tempo de símbolo do sinal em questão.\\[6pt]
Tendo em conta que existem as codificações A e B, tal como apresentado na figura \ref{fig:codificacoes}, foi determinado a melhor forma de obter o tempo de símbolo perante um sinal em que não se sabe à partida qual das duas codificações se trata. Para verificar as suas diferenças foram analisados os tempos de símbolo tal como mostra a seguinte figura.

\begin{figure}[H]
	\centering
	\includegraphics[clip, trim=3cm 23.3cm 5cm 0cm, width=0.92\linewidth]{Figuras/tempoSimbolo}
	\caption{Tempos entre vertentes de codificação A e B.}
	\label{fig:temposimbolo}
\end{figure}

Como se pode observar pela figura \ref{fig:temposimbolo}, na codificação A verificam-se as seguintes condições: $T_{1A} = T_{2A}$ e $T_{3A} \neq T_{4A}$. Já na codificação B verifica-se que $T_{1B} \neq T_{2B}$ e $T_{3B} = T_{4B}$. Assim para obter o tempo de símbolo das codificações do tipo A será entre flancos ascendentes, e do tipo B entre flancos descendentes. Como existem tramas com preâmbulo e outras sem, e como referido, na prática, não existe relação entre o período de preâmbulo e o de símbolo de código, então o primeiro passo é identificar qual dos dois está a ser recebido, e caso seja um preâmbulo é rejeitado.\\[6pt]
Baseando na figura \ref{fig:obtencaotempos}, para a obtenção dos tempos de amostragem, existem dois processos a correr em paralelo. No primeiro são obtidos os tempos $t_{1}$ e $t_{2}$ e calculado o \textit{duty cycle}. No segundo é obtido o tempo $t_{3}$ e calculado o \textit{duty cycle} entre $t_{2}$ e $t_{3}$.\\[6pt]
Como é conhecido, um preâmbulo é um \textit{clock}, e o seu \textit{duty cycle} ronda os $50\%$. Assim são rejeitado todos os \textit{duty cycles} que estejam compreendidos entre $[0.35;0.65]$. Pela figura \ref{fig:simbolos} é conhecido que, se o símbolo for '1', o seu \textit{duty cycle} é de $66.6\%$, e se for '0' é de $33.3\%$ (valores teóricos). Assim para prevenir quais-queres pulsos existentes na linha de dados vindos de fontes interferentes que são capazes de gerar pulsos de curta duração e de forma periódica na linha de dados, foram rejeitados todos os \textit{dutcy cycles} compreendidos no intervalo $[0;0.15]$ e $[0.85;1]$. Assim se um dos \textit{duty cycles} acima referidos estiver compreendido entre $[0.15;0.35] \cup [0.65;0.85]$, significa que é uma zona de código e não um preâmbulo ou um sinal interferente. Caso a condição não se verifique, é repetido o cálculo até que encontre um \textit{duty cycle} válido.\\[6pt]
Assim que uma das condições seja verdadeira é dado o início do próximo passo, do processo respetivo. Este passa por retirar amostras de tempo, agora o tempo retirado é o tempo de símbolo completo, $T_{a}$ (entre flancos ascendentes) ou $T_{b}$(entre flancos descendentes), dependendo de qual o \textit{duty cycle} que se verificou a veracidade. Mais uma vez dependendo desta condição, caso a soma de $t_{1}$ e $t_{2}$ ou $t_{2}$ e $t_{3}$ e o tempo retirado tenha um erro inferior a 15\% diz-se que a amostra é válida. Caso tenha um erro superior a esse valor, diz-se que é inválida e o processo começa novamente, ou seja volta a esperar por um \textit{duty cycle} válido.\\[6pt]
Como é possível que aconteça que ambas as condições sejam verdadeiras (\textit{duty cycles} corretos), foi definido que são necessárias retirar mais 7 amostras de tempo, para que seja decidido qual o tipo de codificação que está a ser recebida, pela verificação do erro entre os tempos retirados. As 7 amostras são as suficientes para que um dos processos volte ao princípio e o outro o termine. Quando um processo termina, concluí-se que os tempos são os corretos e é calculado o tempo de amostragem do código.\\[6pt]
Para este cálculo é feita a média das 8 amostras anteriormente retiradas para minimizar o erro, e depois esta média é dividida por 9 para que sejam retiradas 8 amostras por símbolo. É dividido por 9 porque se o sistema fosse ideal seria feita a amostragem apresentada na figura \ref{fig:amostragem}. Como o sistema não é ideal e está sujeito a atrasos, o número de amostras é variável e está compreendido entre 7 a 9.

\begin{figure}[H]
	\centering
	\includegraphics[clip, trim=0cm 27cm 15.5cm 0cm, width=0.4\linewidth]{Figuras/obtencaoTempos}
	\caption{Obtenção de tempos.}
	\label{fig:obtencaotempos}
\end{figure}

O diagrama funcional da obtenção do tempo de amostragem, está apresentado na \textbf{Figura \ref{fig:diagramatmr5}}.

\begin{figure}[H]
	\centering
	\includegraphics[clip, trim=1cm 27.4cm 13.5cm 0cm, width=0.5\linewidth]{Figuras/amostragem}
	\caption{Amostragem do sinal.}
	\label{fig:amostragem}
\end{figure}

\begin{figure}[H]
	\centering
	\makebox[\textwidth][c]{\includegraphics[clip, trim=0cm 5cm 0.5cm 0cm, width=1\linewidth]{Figuras/DiagramaTMR5}}
	\caption{Diagrama do cálculo do tempo de amostragem.}
	\label{fig:diagramatmr5}
\end{figure}\pagebreak

\begin{itemize}
	\item Obtenção do código
\end{itemize}
\begin{figure}[H]
	\centering
	\makebox[\textwidth][c]{\includegraphics[page=1,angle=90, trim=1cm 0.5cm 1.2cm 0.5cm, width=1\linewidth,height=1.3\textwidth]{Figuras/Diagramacodigo}}
	\caption{Diagrama da obtenção de códigos.}
	\label{fig:diagramacodigo}
\end{figure}

À priori da obtenção do tempo de amostragem, para dar início à obtenção do código, é iniciado um \textit{timer} com o tempo calculado. Com o auxílio deste, é encontrado o fim da trama atual, isto porque, nesta trama já foram perdidos dados e já não servirá. Cada vez que o \textit{timer} atinge o tempo definido, é verificado o valor lógico presente na linha de dados. Como se sabe, no máximo, exitem até 9 amostras num símbolo, e apenas dois terços delas serão zero no caso de ser um '0', então, foi definido que se forem encontrados 10 zeros seguidos, significa que aquela trama terminou. Assim que terminar é esperada uma interrupção na linha de dados, inicio da trama, e aí é iniciado o processo de obtenção de código.\\[6pt]
Pelo diagrama funcional apresentado na figura \ref{fig:diagramacodigo}, são possíveis observar 3 processos em paralelo. O primeiro processo acontece sempre que existe uma interrupção na linha de dados, o segundo quando o \textit{timer}, anteriormente definido rebenta e por último, o terceiro, acontece quando é encontrada o fim de uma trama. Inicialmente, depois de ter sido encontrada a nova trama, através de uma interrupção na linha de dados, com o auxílio do \textit{timer}, é feita a amostragem do primeiro símbolo, isto é, sempre que o \textit{timer} rebenta, tal como para encontrar o fim de trama, é visto o estado lógico da linha de dados e guardado esse valor, bem como o número de amostras que é incrementado.\\[6pt]
Quando ocorre uma interrupção na linha de dados, ascendente ou descendente, dependendo do tipo de codificação (A ou B), definido na obtenção do tempo de amostragem, é verificado o número de amostras. Este número vai definir o porquê do acontecimento, isto é, vai definir se a interrupção despoletada foi dentro da normalidade, ou seja, o símbolo que estava a ser amostrado terminou, ou se a interrupção ocorreu devido a um \textit{glitch}, ou ainda se o que estava a ser amostrado era um preâmbulo em vez de de um código. Como referido, o número de amostras retiradas num símbolo estará sempre compreendido entre 7 a 9 amostras. Então, quando ocorrer uma interrupção na linha de dados, se o número pertencer a este intervalo quer dizer que é um símbolo de código e o processo continua, isto é, vai começar a amostrar o próximo símbolo. Caso o número de amostras seja inferior a 7 amostras, podem se ter dado dois casos: ou ocorreu um \textit{glitch} ou estava a ser recebido um preâmbulo (pela figura \ref{fig:temposimb}, $Nr_{amostras~preamb.[MAX]} = 9\times\frac{2}{3} = 6~amostras$). Como neste momento ainda não se consegue chegar à conclusão de qual dos dois aconteceu, a interrupção é ignorada e a amostragem continua. Quando acontecer a próxima interrupção, caso tenha ocorrido um \textit{glitch} numa zona de código, então o número de amostras estará dentro do intervalo anteriormente referido e o processo contínua, mas caso esteja a ser recebido um preâmbulo, o número de amostras neste momento será superior a 9, o que significa que agora é necessário novamente deixar terminar esta parte da trama e esperar pela seguinte.\\[6pt]
Depois da amostragem do código é necessário encontrar o fim da trama, que tal como anteriormente referido, acontece quando ocorrem 10 zeros consecutivos, amostrados pelo \textit{timer}. Foi definido que para um código ser aceite, por razões de segurança e de robustez, são necessários receber 3 códigos iguais consecutivos. Para isso, se for a primeira trama, esta é guardada e as seguintes são comparadas a esta. Caso as 3 tramas sejam iguais o código é considerado válido, caso uma delas seja diferente o código é rejeitado e todo o processo é recomeçado, chamando a função \textit{default}.
\section{Aplicação \textit{Android}}
A aplicação \textit{Android} permite uma interface entre o utilizador e a U3C de uma forma simplificada. Esta permite a configuração e a atuação na unidade central, tais como:
\begin{itemize}
	\itemsep=-.3mm
	\item Configurar saídas (número da saída, tipo de saídas);
	\item Configurar entradas (como informativas, de fim de curso, de segurança);
	\item Adicionar e/ou remover utilizadores que possam ter permissão na utilização da unidade central;
	\item Adicionar restrições individuais aos utilizadores;
	\item Listar todos os utilizadores que se encontram adicionados na unidade central;
	\item Aceder ao saldo positivo contido no cartão SIM da unidade central;
	\item Acertar a hora e data da U3C;
	\item Visualizar o nível atual de captação de rede da U3C;
	\item Atuar em saídas configuradas a partir de uma chamada telefónica ou de uma SMS.
\end{itemize}
No diagrama da figura \ref{fig:diagramaaplicacao} pode-se observar as funcionalidades da aplicação de uma forma estruturada onde é apresentado uma árvore que contem todas as janelas da aplicação.

\begin{figure}[H]
	\centering
	\includegraphics[clip, trim=7.4cm 3.7cm 4.7cm 2.2cm, width=0.9\linewidth]{Figuras/Software/diagramaaplicacao}
	\caption{Diagrama estrutural da aplicação \textit{Android}.}
	\label{fig:diagramaaplicacao}
\end{figure}

A aplicação inicia com uma janela introdutória onde é pedido o identificador móvel da U3C, ou seja, o seu número de telefone associado, e exigido uma palavra-passe, onde esta se encontra configurada por defeito e poderá ser alterado pelo administrador. Após o início da aplicação é apresentado a janela principal, nesta é permitido efetuar os acionamentos que se encontram configurados. Na figura \ref{fig:android1} pode-se observar a janelas apresentadas.
\begin{figure}[H]
	\centering
	\begin{subfigure}{.5\textwidth}
		\centering
		\includegraphics[clip, trim=5.7cm 19cm 10cm 2.7cm, width=0.5\linewidth]{Figuras/Software/p1}
		\captionsetup{labelformat=empty}
		\caption{(a) Janela introdutória.}
	\end{subfigure}%
	\begin{subfigure}{.5\textwidth}
		\centering
		\includegraphics[clip, trim=5.7cm 19cm 10cm 2.7cm, width=0.5\linewidth]{Figuras/Software/p2}
		\captionsetup{labelformat=empty}
		\caption{(b) Janela principal.}
	\end{subfigure}
	\caption{Janelas iniciais da aplicação \textit{Android}.}
	\label{fig:android1}
\end{figure}
\begin{figure}[H]
	\centering
	\begin{subfigure}{.5\textwidth}
		\centering
		\includegraphics[clip, trim=5.7cm 19cm 10cm 2.7cm, width=0.5\linewidth]{Figuras/Software/p3}
		\captionsetup{labelformat=empty}
		\caption{(a) Janela de informação da empresa.}
	\end{subfigure}%
	\begin{subfigure}{.5\textwidth}
		\centering
		\includegraphics[clip, trim=5.7cm 19cm 10cm 2.7cm, width=0.5\linewidth]{Figuras/Software/p4}
		\captionsetup{labelformat=empty}
		\caption{(b) Janela do menu principal.}
	\end{subfigure}
	\caption{Janelas da aplicação \textit{Android}.}
	\label{fig:android2}
\end{figure}
Na janela principal encontram-se dois \textit{icons} na barra superior onde no \textit{icon} da esquerda é apresentado uma informação da empresa Imporvia, para eventuais contactos necessários a efetuar com a empresa, e do lado direito um \textit{icon} que permite entrar nas configurações da unidade central. Na figura \ref{fig:android2} encontram-se representadas as janelas descritas.\\[6pt]
As configurações básicas são apresentadas na janela do menu principal, onde é permitido a adição de novos utilizadores, remover utilizadores, listar todos os utilizadores adicionados, visualizar o saldo positivo da unidade central (se possível), acertar a hora da unidade central, e por fim, visualizar o nível de rede móvel da U3C.\\[6pt]
Ao adicionar um utilizador é pedido alguns dados referentes a este. É pedido uma identificação (um nome), o número de telefone, e o tipo de utilizador. Os utilizadores podem ser caracterizados com um utilizador comum, administrador, ou um utilizador com restrições. Para um utilizador comum, este não tem quaisquer restrições de acesso, contudo não pode efetuar alterações de configuração da U3C, apenas poderá ser feito por um utilizador administrado. Um utilizador com restrições terá permissão de utilização da U3C nos horários definidos pelo administrador.\\[6pt]
Para remover um utilizador é apenas necessário a inserção do identificado móvel do utilizador que se pretende eliminar e efetuar a sua confirmação. A janela de adição do utilizador é ilustrada na figura \ref{fig:android3}, assim como a janela de remover utilizador.
\begin{figure}[H]
	\centering
	\begin{subfigure}{.5\textwidth}
		\centering
		\includegraphics[clip, trim=5.7cm 19cm 10cm 2.7cm, width=0.5\linewidth]{Figuras/Software/p5}
		\captionsetup{labelformat=empty}
		\caption{(a) Janela de adição de utilizador.}
	\end{subfigure}% 
	\begin{subfigure}{.5\textwidth}
		\centering
		\includegraphics[clip, trim=5.7cm 19cm 10cm 2.7cm, width=0.5\linewidth]{Figuras/Software/p6}
		\captionsetup{labelformat=empty}
		\caption{(b) Janela de remoção de utilizador.}
	\end{subfigure}
	\caption{Janelas de gestão de utilizadores.}
	\label{fig:android3}
\end{figure}
Como já anteriormente foi referido, a aplicação \textit{Android} é a interface de configuração das saídas e entradas do módulo. Estas configurações são de ordem mais técnica, pois apenas o instalador do equipamento tem o conhecimento da forma que devem ser atuadas os mecanismos interligados com a U3C. Deste modo este género de configurações tem um acesso menos claro. As configurações podem ser acedidas deslizando o ecrã, da esquerda para a direita, onde aparecerá uma coluna com as configurações possíveis, figura \ref{fig:android4}. Neste também é possível aceder a um breve manual de instruções e a um compartimento que sita o projeto em si.
\begin{figure}[H]
	\centering
	\includegraphics[clip, trim=6cm 19cm 10cm 3cm, width=0.25\linewidth]{Figuras/Software/p7}
	\caption{Janela de configuração técnica da unidade central.}
	\label{fig:android4}
\end{figure}
Na figura \ref{fig:android5} encontra-se representado as janelas informativas mencionadas anteriormente.
\begin{figure}[H]
	\centering
	\begin{subfigure}{.5\textwidth}
		\centering
		\includegraphics[clip, trim=5.7cm 19cm 10cm 2.7cm, width=0.5\linewidth]{Figuras/Software/p11}
		\captionsetup{labelformat=empty}
		\caption{(a) Janela de instruções para o utilizador.}
	\end{subfigure}% 
	\begin{subfigure}{.5\textwidth}
		\centering
		\includegraphics[clip, trim=5.7cm 19cm 10cm 2.7cm, width=0.5\linewidth]{Figuras/Software/p12}
		\captionsetup{labelformat=empty}
		\caption{(b) Janela de apresentação do projeto.}
	\end{subfigure}
	\caption{Janelas informativas da aplicação \textit{Android}.}
	\label{fig:android5}
\end{figure}
Dentro das configurações encontra-se uma ligação que permite a alteração do identificador móvel da unidade central, figura \ref{fig:android6}, assim como a alteração do código de segurança. Ao ser alterado o código segurança é enviado, via SMS, uma mensagem com o novo código e alterado se o utilizador for administrador.
\begin{figure}[H]
	\centering
	\includegraphics[clip, trim=6cm 19cm 10cm 3cm, width=0.25\linewidth]{Figuras/Software/p8}
	\caption{Janela de configuração geral.}
	\label{fig:android6}
\end{figure}
A configuração das saídas possibilita a configuração do tipo de acionamento de cada saída física da U3C, figura \ref{fig:android7a}. Esta configuração apenas se aplica a três saídas físicas, pois uma das saídas é reservada para a comunicação a partir de uma chamada.
Em cada automatismo (saída) é possível escolher uma imagem que a representa, o número físico das saídas (2 a 4), e o tipo de atuação (permanente, temporizado ou controlado). Para cada tipo de atuação existe configurações adicionais diferentes. A figura \ref{fig:android7b} ilustra as configurações possíveis para uma determinada saída.
\begin{figure}[H]
	\centering
	\begin{subfigure}{.5\textwidth}
		\centering
		\includegraphics[clip, trim=5.7cm 19cm 10cm 2.7cm, width=0.5\linewidth]{Figuras/Software/p9}
		\captionsetup{labelformat=empty}
		\caption{(a) Janela de adição e edição de saídas.}
		\label{fig:android7a}
	\end{subfigure}% 
	\begin{subfigure}{.5\textwidth}
		\centering
		\includegraphics[clip, trim=5.7cm 19cm 10cm 2.7cm, width=0.5\linewidth]{Figuras/Software/p10}
		\captionsetup{labelformat=empty}
		\caption{(b) Janela de configuração de uma saída.}
		\label{fig:android7b}
	\end{subfigure}
	\caption{Janelas de configuração de automatismos.}
	\label{fig:android7}
\end{figure}
Por fim, implementou-se um método rápido para o utilizador operar. Trata-se um uma miniaplicação (\textit{widget}) que contém apenas os botões configurados e poderão atuar sem a necessidade de abrir a aplicação principal. Esta miniaplicação pode ser vista na figura \ref{fig:android8}, que se encontra na parte inferior do ecrã.
\begin{figure}[H]
	\centering
	\includegraphics[clip, trim=6cm 19cm 10cm 3cm, width=0.25\linewidth]{Figuras/Software/p13}
	\caption{Miniaplicação de interface com a unidade central.}
	\label{fig:android8}
\end{figure}

\section{Sumário}
Neste capítulo foram exibidas as rotinas principais efetuadas pelo microcontrolador, sendo estas a interface com o módulo RF e com o módulo GSM. No final foi apresentado as funcionalidade da aplicação \textit{Android} juntamente com um diagrama sequencial.
